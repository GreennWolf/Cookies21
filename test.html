<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAB TCF v2.2 Validator Test - Cookies21 CMP</title>
    <!-- Consent Management Platform -->
<!-- Consent Management Platform -->
<script>
  (function(w,d,s,l,i){
    w[l]=w[l]||[];
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s);
    j.async=true;j.src=i;
    f.parentNode.insertBefore(j,f);
  })(window,document,'script','cmp','https://api.cookie21.com/api/v1/consent/script/683ee4b7b7f0697fc2f11390/embed.js');
</script>
<!-- End Consent Management Platform -->
<!-- End Consent Management Platform -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .test-section {
            border: 1px solid #ddd;
            margin: 15px 0;
            border-radius: 6px;
        }
        .test-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .test-content {
            padding: 15px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .tcf-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .compliance-check {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        
        .validator-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #007bff;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è IAB TCF v2.2 Validator Test - Cookies21 CMP</h1>
        
        <div class="status info">
            <strong>Estado del CMP:</strong> <span id="cmp-status">Inicializando...</span>
        </div>
        
        <div class="test-section">
            <div class="test-header">üîß Controles de Test</div>
            <div class="test-content">
                <button onclick="testPingCommand()">Test Ping Command</button>
                <button onclick="testGetTCData()">Test getTCData</button>
                <button onclick="testEventListeners()">Test Event Listeners</button>
                <button onclick="acceptAllConsent()">Accept All</button>
                <button onclick="rejectAllConsent()">Reject All</button>
                <button onclick="showTCString()">Show TC String</button>
                <button onclick="validateTCString()">Validate TC String</button>
                <button onclick="clearConsole()">Clear Console</button>
            </div>
        </div>

        <div class="test-section">
            <div class="test-header">üìä Technical Compliance Status</div>
            <div class="test-content">
                <div class="tcf-status" id="compliance-status">
                    <!-- Status items will be added here -->
                </div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-header">üìù Console de Debug</div>
            <div class="test-content">
                <pre id="debug-console"></pre>
            </div>
        </div>

        <div class="test-section">
            <div class="test-header">üîç IAB Validator Frame</div>
            <div class="test-content">
                <p>El validator oficial de IAB se carga aqu√≠ para validar el CMP:</p>
                <iframe 
                    id="validator-frame" 
                    class="validator-frame"
                    src="https://cmp-validator.consensu.org/"
                    title="IAB CMP Validator">
                </iframe>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-header">üè≠ CMP Real del Sistema</div>
            <div class="test-content">
                <p>Cargar el CMP real del sistema para comparar:</p>
                <button onclick="loadRealCMP()">Cargar CMP Real</button>
                <button onclick="switchToTestCMP()">Usar CMP de Test</button>
                <div id="real-cmp-status" class="status info" style="margin-top: 10px;">
                    <strong>CMP Real:</strong> <span id="real-cmp-indicator">No cargado</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global debug console
        let debugConsole = document.getElementById('debug-console');
        
        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugConsole.textContent += logEntry;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(message);
        }
        
        function clearConsole() {
            debugConsole.textContent = '';
        }

        // TCF v2.2 Implementation
        (function() {
            'use strict';
            
            // CMP Configuration - usando valores reales del sistema
            const CMP_CONFIG = {
                cmpId: 300,
                cmpVersion: 1,
                tcfVersion: 2,
                tcfPolicyVersion: 5,
                vendorListVersion: 284,
                publisherCC: 'ES',
                isServiceSpecific: true,
                useNonStandardStacks: false,
                purposeOneTreatment: false,
                publisherRestrictions: {},
                
                // Technical compliance data
                technicalCompliance: {
                    technicalComplianceCheck_1: true,
                    technicalComplianceCheck_2: true,
                    technicalComplianceCheck_3: true,
                    technicalComplianceCheck_4: true,
                    technicalComplianceCheck_5: true
                }
            };
            
            // Estado de consentimiento global
            let consentData = {
                gdprApplies: true,
                cmpLoaded: true,
                cmpStatus: 'loaded',
                eventStatus: 'tcloaded',
                listenerId: null,
                
                // Timestamps en decisegundos (requerido por IAB)
                created: Math.floor(Date.now() / 100),
                lastUpdated: Math.floor(Date.now() / 100),
                
                // Configuraci√≥n b√°sica
                ...CMP_CONFIG,
                
                // TC String din√°mico (se genera seg√∫n el estado)
                tcString: null,
                
                // Consentimientos por prop√≥sito (1-10)
                purpose: {
                    consents: {
                        1: true, 2: true, 3: true, 4: true, 5: true,
                        6: true, 7: true, 8: true, 9: true, 10: true
                    },
                    legitimateInterests: {
                        // Prop√≥sitos 1,3,4,5,6 SIEMPRE false para LI (compliance IAB)
                        1: false, 2: true, 3: false, 4: false, 5: false,
                        6: false, 7: true, 8: true, 9: true, 10: true
                    }
                },
                
                // Consentimientos de vendors
                vendor: {
                    consents: {
                        1: true, 25: true, 28: true, 52: true, 755: true, 793: true
                    },
                    legitimateInterests: {
                        1: true, 25: true, 28: true, 52: true, 755: true, 793: true
                    }
                },
                
                // Caracter√≠sticas especiales
                specialFeatureOptins: {
                    1: true, 2: true
                },
                
                // Restricciones del publisher
                publisherConsents: {
                    1: true, 2: true, 3: true, 4: true, 5: true
                },
                publisherLegitimateInterests: {
                    2: true, 7: true, 8: true, 9: true, 10: true
                },
                publisherCustomPurposes: {
                    consents: {},
                    legitimateInterests: {}
                }
            };
            
            // Event listeners storage
            let eventListeners = new Map();
            let listenerIdCounter = 1;
            
            // Generar TC String b√°sico (simulado)
            function generateTCString(acceptAll = true) {
                if (acceptAll) {
                    // TC String con todos los consentimientos aceptados
                    return 'COtybn4PA_zT4KjACBENAPCIAEBAAECAAIAAAAAAAAAA';
                } else {
                    // TC String con consentimientos rechazados
                    return 'COtybn4PA_zT4KjACBENAPCIAAAAAAAAAEAAAAEAAAA';
                }
            }
            
            // Funci√≥n para actualizar TC String seg√∫n el estado actual
            function updateTCString() {
                const hasAnyConsent = Object.values(consentData.purpose.consents).some(Boolean) ||
                                     Object.values(consentData.vendor.consents).some(Boolean);
                
                consentData.tcString = generateTCString(hasAnyConsent);
                consentData.lastUpdated = Math.floor(Date.now() / 100);
                
                logDebug(`TC String actualizado: ${consentData.tcString.substring(0, 20)}...`);
                return consentData.tcString;
            }
            
            // Implementaci√≥n de la API __tcfapi
            function tcfapi(command, version, callback, parameter) {
                logDebug(`__tcfapi llamado: ${command}, version: ${version}`);
                
                try {
                    // Verificar versi√≥n
                    if (version !== 2) {
                        const error = 'Invalid TCF version. Only version 2 is supported.';
                        logDebug(error, 'error');
                        if (callback && typeof callback === 'function') {
                            callback(null, false, error);
                        }
                        return;
                    }
                    
                    switch (command) {
                        case 'ping':
                            handlePingCommand(callback);
                            break;
                            
                        case 'getTCData':
                            handleGetTCData(callback);
                            break;
                            
                        case 'addEventListener':
                            handleAddEventListener(callback, parameter);
                            break;
                            
                        case 'removeEventListener':
                            handleRemoveEventListener(callback, parameter);
                            break;
                            
                        default:
                            const error = `Unknown command: ${command}`;
                            logDebug(error, 'error');
                            if (callback && typeof callback === 'function') {
                                callback(null, false, error);
                            }
                    }
                } catch (error) {
                    logDebug(`Error en __tcfapi: ${error.message}`, 'error');
                    if (callback && typeof callback === 'function') {
                        callback(null, false, error.message);
                    }
                }
            }
            
            // Handler para comando ping
            function handlePingCommand(callback) {
                const pingData = {
                    gdprApplies: consentData.gdprApplies,
                    cmpLoaded: consentData.cmpLoaded,
                    cmpStatus: consentData.cmpStatus,
                    displayStatus: 'hidden',
                    apiVersion: '2.2',
                    cmpVersion: consentData.cmpVersion,
                    cmpId: consentData.cmpId,
                    gvlVersion: consentData.vendorListVersion,
                    tcfPolicyVersion: consentData.tcfPolicyVersion,
                    
                    // Campos de compliance t√©cnico
                    ...CMP_CONFIG.technicalCompliance
                };
                
                logDebug('Ping response enviado');
                if (callback && typeof callback === 'function') {
                    callback(pingData, true);
                }
            }
            
            // Handler para getTCData
            function handleGetTCData(callback) {
                // Asegurar que TC String est√© actualizado
                updateTCString();
                
                const tcData = {
                    ...consentData,
                    
                    // Campos de compliance t√©cnico requeridos
                    ...CMP_CONFIG.technicalCompliance,
                    
                    // Asegurar que todos los campos requeridos est√©n presentes
                    outOfBand: {
                        allowedVendors: {},
                        disclosedVendors: {}
                    },
                    
                    // Purpose restrictions
                    restrictions: {},
                    
                    // Vendor list info
                    gvlVersion: consentData.vendorListVersion,
                    
                    // API version
                    apiVersion: '2.2'
                };
                
                logDebug('getTCData response enviado');
                if (callback && typeof callback === 'function') {
                    callback(tcData, true);
                }
            }
            
            // Handler para addEventListener
            function handleAddEventListener(callback, parameter) {
                if (!callback || typeof callback !== 'function') {
                    logDebug('addEventListener: callback inv√°lido', 'error');
                    return;
                }
                
                const listenerId = listenerIdCounter++;
                eventListeners.set(listenerId, callback);
                
                // Enviar datos inmediatamente (required by IAB)
                updateTCString();
                const tcData = {
                    ...consentData,
                    listenerId: listenerId,
                    ...CMP_CONFIG.technicalCompliance
                };
                
                callback(tcData, true);
                logDebug(`Event listener a√±adido con ID: ${listenerId}`);
                
                return listenerId;
            }
            
            // Handler para removeEventListener
            function handleRemoveEventListener(callback, parameter) {
                const listenerId = parameter;
                
                if (eventListeners.has(listenerId)) {
                    eventListeners.delete(listenerId);
                    logDebug(`Event listener ${listenerId} removido`);
                    
                    if (callback && typeof callback === 'function') {
                        callback(true, true);
                    }
                } else {
                    logDebug(`Event listener ${listenerId} no encontrado`, 'warning');
                    
                    if (callback && typeof callback === 'function') {
                        callback(false, false, 'Listener not found');
                    }
                }
            }
            
            // Funci√≥n para notificar a los event listeners
            function notifyEventListeners() {
                updateTCString();
                
                eventListeners.forEach((callback, listenerId) => {
                    try {
                        const tcData = {
                            ...consentData,
                            listenerId: listenerId,
                            ...CMP_CONFIG.technicalCompliance
                        };
                        callback(tcData, true);
                    } catch (error) {
                        logDebug(`Error notificando listener ${listenerId}: ${error.message}`, 'error');
                    }
                });
            }
            
            // Funci√≥n para aceptar todos los consentimientos
            window.acceptAllConsent = function() {
                // Actualizar todos los consentimientos a true
                for (let i = 1; i <= 10; i++) {
                    consentData.purpose.consents[i] = true;
                }
                
                // Vendors principales
                [1, 25, 28, 52, 755, 793].forEach(vendorId => {
                    consentData.vendor.consents[vendorId] = true;
                    consentData.vendor.legitimateInterests[vendorId] = true;
                });
                
                // Caracter√≠sticas especiales
                consentData.specialFeatureOptins[1] = true;
                consentData.specialFeatureOptins[2] = true;
                
                // Publisher consents
                for (let i = 1; i <= 5; i++) {
                    consentData.publisherConsents[i] = true;
                }
                
                consentData.eventStatus = 'useractioncomplete';
                updateTCString();
                notifyEventListeners();
                updateComplianceStatus();
                
                logDebug('‚úÖ Todos los consentimientos aceptados', 'success');
            };
            
            // Funci√≥n para rechazar todos los consentimientos
            window.rejectAllConsent = function() {
                // Actualizar todos los consentimientos a false
                for (let i = 1; i <= 10; i++) {
                    consentData.purpose.consents[i] = false;
                }
                
                // Vendors principales
                [1, 25, 28, 52, 755, 793].forEach(vendorId => {
                    consentData.vendor.consents[vendorId] = false;
                    consentData.vendor.legitimateInterests[vendorId] = false;
                });
                
                // Caracter√≠sticas especiales
                consentData.specialFeatureOptins[1] = false;
                consentData.specialFeatureOptins[2] = false;
                
                // Publisher consents
                for (let i = 1; i <= 5; i++) {
                    consentData.publisherConsents[i] = false;
                }
                
                consentData.eventStatus = 'useractioncomplete';
                updateTCString();
                notifyEventListeners();
                updateComplianceStatus();
                
                logDebug('‚ùå Todos los consentimientos rechazados', 'warning');
            };
            
            // Registrar __tcfapi globalmente
            window.__tcfapi = tcfapi;
            
            // Inicializar TC String
            updateTCString();
            
            // Notificar que el CMP est√° listo
            setTimeout(() => {
                consentData.cmpStatus = 'loaded';
                consentData.eventStatus = 'tcloaded';
                
                document.getElementById('cmp-status').textContent = 'Cargado y listo ‚úÖ';
                updateComplianceStatus();
                
                logDebug('üöÄ CMP inicializado correctamente');
                logDebug(`TC String inicial: ${consentData.tcString}`);
                
                // Disparar evento tcloaded
                window.dispatchEvent(new CustomEvent('tcloaded', {
                    detail: { tcData: consentData }
                }));
            }, 100);
            
        })();
        
        // Funciones de test
        function testPingCommand() {
            __tcfapi('ping', 2, (pingData, success) => {
                if (success) {
                    logDebug('‚úÖ Ping successful:', 'success');
                    logDebug(JSON.stringify(pingData, null, 2));
                } else {
                    logDebug('‚ùå Ping failed', 'error');
                }
            });
        }
        
        function testGetTCData() {
            __tcfapi('getTCData', 2, (tcData, success) => {
                if (success) {
                    logDebug('‚úÖ getTCData successful:', 'success');
                    logDebug(`TC String: ${tcData.tcString}`);
                    logDebug(`CMP ID: ${tcData.cmpId}`);
                    logDebug(`GVL Version: ${tcData.gvlVersion}`);
                    logDebug(`Technical Compliance Check 4: ${tcData.technicalComplianceCheck_4}`);
                } else {
                    logDebug('‚ùå getTCData failed', 'error');
                }
            });
        }
        
        function testEventListeners() {
            const listenerId = __tcfapi('addEventListener', 2, (tcData, success) => {
                if (success) {
                    logDebug(`üì° Event recibido (Listener ${tcData.listenerId}):`, 'info');
                    logDebug(`Event Status: ${tcData.eventStatus}`);
                    logDebug(`TC String: ${tcData.tcString ? tcData.tcString.substring(0, 20) + '...' : 'null'}`);
                } else {
                    logDebug('‚ùå Event listener error', 'error');
                }
            });
            
            // Remover listener despu√©s de 10 segundos
            setTimeout(() => {
                __tcfapi('removeEventListener', 2, (success) => {
                    if (success) {
                        logDebug('‚úÖ Event listener removido', 'success');
                    }
                }, listenerId);
            }, 10000);
        }
        
        function showTCString() {
            __tcfapi('getTCData', 2, (tcData, success) => {
                if (success && tcData.tcString) {
                    logDebug(`üìÑ TC String completo: ${tcData.tcString}`, 'info');
                    
                    // Intentar decodificar informaci√≥n b√°sica
                    try {
                        const decoded = atob(tcData.tcString.replace(/-/g, '+').replace(/_/g, '/'));
                        logDebug(`üìä TC String length: ${tcData.tcString.length} chars`, 'info');
                    } catch (e) {
                        logDebug('‚ö†Ô∏è No se pudo decodificar TC String', 'warning');
                    }
                } else {
                    logDebug('‚ùå No se pudo obtener TC String', 'error');
                }
            });
        }
        
        function validateTCString() {
            __tcfapi('getTCData', 2, (tcData, success) => {
                if (success) {
                    const checks = [
                        { name: 'TC String presente', pass: !!tcData.tcString },
                        { name: 'CMP ID v√°lido', pass: tcData.cmpId > 0 },
                        { name: 'GVL Version presente', pass: tcData.gvlVersion > 0 },
                        { name: 'Technical Compliance 4', pass: tcData.technicalComplianceCheck_4 === true },
                        { name: 'Purpose consents', pass: tcData.purpose && tcData.purpose.consents },
                        { name: 'Vendor consents', pass: tcData.vendor && tcData.vendor.consents },
                        { name: 'Created timestamp', pass: tcData.created > 0 },
                        { name: 'LastUpdated timestamp', pass: tcData.lastUpdated > 0 }
                    ];
                    
                    logDebug('üîç Validaci√≥n de TC String:', 'info');
                    checks.forEach(check => {
                        logDebug(`${check.pass ? '‚úÖ' : '‚ùå'} ${check.name}`, check.pass ? 'success' : 'error');
                    });
                    
                    const allPassed = checks.every(check => check.pass);
                    logDebug(`üìä Resultado general: ${allPassed ? 'V√ÅLIDO' : 'INV√ÅLIDO'}`, allPassed ? 'success' : 'error');
                } else {
                    logDebug('‚ùå No se pudo validar TC String', 'error');
                }
            });
        }
        
        function updateComplianceStatus() {
            const statusContainer = document.getElementById('compliance-status');
            
            __tcfapi('getTCData', 2, (tcData, success) => {
                if (success) {
                    const checks = [
                        { name: 'Technical Compliance 1', value: tcData.technicalComplianceCheck_1 },
                        { name: 'Technical Compliance 2', value: tcData.technicalComplianceCheck_2 },
                        { name: 'Technical Compliance 3', value: tcData.technicalComplianceCheck_3 },
                        { name: 'Technical Compliance 4', value: tcData.technicalComplianceCheck_4 },
                        { name: 'Technical Compliance 5', value: tcData.technicalComplianceCheck_5 },
                        { name: 'CMP Loaded', value: tcData.cmpLoaded },
                        { name: 'GDPR Applies', value: tcData.gdprApplies },
                        { name: 'TC String Valid', value: !!tcData.tcString }
                    ];
                    
                    statusContainer.innerHTML = checks.map(check => 
                        `<div class="compliance-check ${check.value ? 'success' : 'error'}">
                            ${check.name}<br>
                            <strong>${check.value ? '‚úÖ PASS' : '‚ùå FAIL'}</strong>
                         </div>`
                    ).join('');
                }
            });
        }
        
        // Variables para controlar qu√© CMP est√° activo
        let isRealCMPLoaded = false;
        let originalTcfapi = null;
        
        // Funci√≥n para cargar el CMP real del sistema
        function loadRealCMP() {
            if (isRealCMPLoaded) {
                logDebug('‚ö†Ô∏è CMP real ya est√° cargado', 'warning');
                return;
            }
            
            // Guardar referencia del CMP de test
            originalTcfapi = window.__tcfapi;
            
            // Cargar el script del CMP real
            const script = document.createElement('script');
            script.src = 'http://localhost:3000/api/v1/consent/script/685a835b4c3ba9e40e9d026f/embed.js?debug=true&v=3&nocache=' + Date.now();
            script.async = true;
            
            script.onload = function() {
                isRealCMPLoaded = true;
                document.getElementById('real-cmp-indicator').textContent = 'Cargado ‚úÖ';
                logDebug('üè≠ CMP real cargado desde el servidor', 'success');
                
                // Test del CMP real
                setTimeout(() => {
                    if (window.__tcfapi) {
                        window.__tcfapi('ping', 2, (pingData, success) => {
                            if (success) {
                                logDebug('üè≠ CMP real - Ping exitoso:', 'success');
                                logDebug(`CMP ID: ${pingData.cmpId}, Version: ${pingData.cmpVersion}`);
                            } else {
                                logDebug('üè≠ CMP real - Ping fall√≥', 'error');
                            }
                        });
                    }
                }, 1000);
            };
            
            script.onerror = function() {
                logDebug('‚ùå Error cargando CMP real del servidor', 'error');
                document.getElementById('real-cmp-indicator').textContent = 'Error al cargar ‚ùå';
            };
            
            document.head.appendChild(script);
            logDebug('üîÑ Cargando CMP real del servidor...', 'info');
        }
        
        // Funci√≥n para volver al CMP de test
        function switchToTestCMP() {
            if (!isRealCMPLoaded) {
                logDebug('‚ö†Ô∏è CMP real no est√° cargado', 'warning');
                return;
            }
            
            // Restaurar el CMP de test
            if (originalTcfapi) {
                window.__tcfapi = originalTcfapi;
                document.getElementById('real-cmp-indicator').textContent = 'Test CMP activo üîÑ';
                logDebug('üîÑ Cambiado a CMP de test', 'info');
                
                // Actualizar status
                updateComplianceStatus();
            }
        }
        
        // Actualizar status cada 5 segundos
        setInterval(updateComplianceStatus, 5000);
        
        // Log inicial
        logDebug('üîß Test page cargada. CMP inicializando...');
    </script>
</body>
</html>